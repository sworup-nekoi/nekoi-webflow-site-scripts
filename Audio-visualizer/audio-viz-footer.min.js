(function(){function t(){try{const d=document.getElementById("audio-viz")||document.querySelector(".audio-visualizer");if(!d)return;const l=document.getElementById("site-music")||document.querySelector('audio[data-role="site-music"]')||document.querySelector("audio#site-audio")||document.querySelector("audio[src]");if(!l)return;try{l.crossOrigin=l.crossOrigin||"anonymous"}catch{}l.preload=l.preload||"auto";try{l.setAttribute("playsinline",""),l.setAttribute("webkit-playsinline","")}catch{}const u="viz:was-playing",m="viz:last-time",h=document.createElement("canvas"),p=h.getContext("2d");Object.assign(h.style,{position:"absolute",inset:"0",width:"100%",height:"100%",display:"block",pointerEvents:"none"}),d.appendChild(h);const v=document.body||document.documentElement,g=(t,e)=>{let a=getComputedStyle(v).getPropertyValue(t).trim();return a||(a=getComputedStyle(document.documentElement).getPropertyValue(t).trim()),a||e},y=(t,e)=>{const a=document.createElement("div");a.style.position="absolute",a.style.visibility="hidden",a.style.width=`var(${t})`,(document.body||document.documentElement).appendChild(a);const n=parseFloat(getComputedStyle(a).width);return a.remove(),Number.isFinite(n)?n:e};let f,w,M,x,b,z,S,E,I,F,L,T,_,A,C,V,k,q,P,O,B,R,D;function t(){f=g("--viz-bar","#fff"),w=g("--viz-bar-alt",f),M=g("--viz-cap","transparent"),S=y("--viz-pad-x",8),E=y("--viz-gap",2),I=Math.max(1,parseInt(g("--viz-max-bars","64"),10)||64),F=Math.max(1,y("--viz-min-bar",8)),x=y("--viz-cap-gap",2),b=y("--viz-cap-h",2),z=Math.max(.02,parseFloat(g("--viz-cap-drop","0.6"))||.6),L=Math.max(.4,parseFloat(g("--viz-band-curve","1.6"))||1.6),T=Math.max(1,parseInt(g("--viz-alt-every","2"),10)||2),_="0"!==g("--viz-agc","1"),A=Math.min(.5,Math.max(.01,parseFloat(g("--viz-agc-smooth","0.1"))||.1)),C=Math.max(1,parseFloat(g("--viz-agc-max","16"))||16),V=Math.max(.1,parseFloat(g("--viz-sensitivity","1.35"))||1.35),k=Math.min(.98,Math.max(0,parseFloat(g("--viz-smoothing","0.60"))||.6)),q=Math.max(0,parseFloat(g("--viz-quiet-boost","1.45"))||1.45),P=Math.min(1,Math.max(0,parseFloat(g("--viz-min-active-frac","0.40"))||.4)),O=y("--viz-min-active-px",3),B=y("--viz-idle-px",2),R=Math.max(0,Math.min(.2,parseFloat(g("--viz-silence-thresh","0.02"))||.02)),D=(g("--viz-align","left")||"left").toLowerCase()}t();const N=new MutationObserver(t);N.observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme","data-wf-theme","class"]}),N.observe(document.body,{attributes:!0,attributeFilter:["data-theme","data-wf-theme","class"]});const W=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)");W&&W.addEventListener&&W.addEventListener("change",t);const j=window.AudioContext||window.webkitAudioContext,G=new j;let H;try{H=G.createMediaElementSource(l)}catch{return}const U=G.createAnalyser();U.fftSize=512,U.smoothingTimeConstant=k;const $=G.createGain();function e(t,e=300){const a=G.currentTime,n=Math.max(.001,(0|e)/1e3),i=$.gain;try{i.cancelScheduledValues(a),i.setValueAtTime(i.value,a),i.linearRampToValueAtTime(Math.max(0,Math.min(1,t)),a+n)}catch{}return new Promise(t=>setTimeout(t,Math.max(0,0|e)))}async function a(t=800){try{await G.resume()}catch{}try{await l.play()}catch{}sessionStorage.setItem(u,"1"),await e(1,t)}async function n(t=400){await e(0,t),l.pause(),sessionStorage.setItem(u,"0");try{sessionStorage.setItem(m,String(l.currentTime||0))}catch{}}function i(t={}){const e=t.selector||"[data-viz-toggle]";document.querySelectorAll(e).forEach(e=>o(e,t))}function o(t,e={}){const i=+t.dataset.fadeIn||e.fadeInMs||800,o=+t.dataset.fadeOut||e.fadeOutMs||400;t.setAttribute("role","button"),t.hasAttribute("tabindex")||(t.tabIndex=0);let s=0;const r=t=>{t&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation&&t.stopImmediatePropagation())},c=e=>{t.classList.toggle("is-playing",!!e),t.setAttribute("aria-pressed",e?"true":"false")},d=t=>{t&&"click"===t.type&&Date.now()-s<350||(r(t),l.paused||l.ended?a(i).then(()=>c(!0)):n(o).then(()=>c(!1)))};t.addEventListener("touchend",t=>{s=Date.now(),d(t)},{passive:!1}),t.addEventListener("click",d,{passive:!1}),t.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||d(t)});const m="1"===sessionStorage.getItem(u)&&!l.paused;c(m)}$.gain.value=0,H.connect($),$.connect(G.destination),$.connect(U),function(){if(l.__vizPersistBound)return;l.__vizPersistBound=!0;const t=()=>{try{sessionStorage.setItem(m,String(l.currentTime||0))}catch{}};l.addEventListener("pause",t),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&t()}),window.addEventListener("pagehide",t),setInterval(()=>{l.paused||t()},2e3)}(),window.__audioViz={audio:l,context:G,analyser:U,gain:$,fadeTo:e,playWithFade:a,pauseWithFade:n,initToggle:i};let J=Math.max(1,window.devicePixelRatio||1);const K={count:0,ranges:[]};function s(){J=Math.max(1,window.devicePixelRatio||1);const e=d.clientWidth||1,a=d.clientHeight||1;h.width=Math.max(1,Math.round(e*J)),h.height=Math.max(1,Math.round(a*J)),p.setTransform(J,0,0,J,0,0),t(),K.count=0}s(),window.addEventListener("resize",s,{passive:!0}),window.visualViewport&&visualViewport.addEventListener("resize",s,{passive:!0});const Q=new Uint8Array(U.frequencyBinCount);function r(t,e,a=2,n=e){const i=Math.max(a+1,Math.min(n,e)),o=Math.max(1,i-a),s=[];for(let e=0;e<t;e++){const n=e/t,r=(e+1)/t,c=Math.pow(n,L),d=Math.pow(r,L);let l=Math.floor(a+c*o),u=Math.floor(a+d*o);l<a&&(l=a),u<=l&&(u=Math.min(i,l+1)),u>i&&(u=i),s.push({i0:l,i1:u})}return s}let X=[],Y=1,Z=0;function c(){Z++%12==0&&t(),U.smoothingTimeConstant=k;const e=h.width/J,a=h.height/J;p.clearRect(0,0,e,a),U.getByteFrequencyData(Q);const n=Math.max(1,e-2*S);let i=Math.max(1,Math.floor(n/Math.max(1,F)));i=Math.min(I,i);let o=[];for(let t=0;t<i;t++)o[t]=t;"right"===D&&o.reverse();const s=E*Math.max(0,i-1),d=Math.max(1,(n-s)/i),u=a-2,m=Math.max(1,u-6);K.count!==i&&(K.count=i,K.ranges=r(i,Q.length,2,Q.length),X=new Array(i).fill(u-x));const v=new Array(i);let g=1e-4;for(let t=0;t<i;t++){const{i0:e,i1:a}=K.ranges[t];let n=0,i=Math.max(1,a-e);for(let t=e;t<a;t++)n+=Q[t]||0;let o=n/i/255;o=Math.max(0,Math.min(1,o*V)),v[t]=o,o>g&&(g=o)}const y=l.paused||l.muted||g<R;if(!y&&_){const t=Math.min(C,.9/g);Y+=(t-Y)*A}else Y+=.2*(1-Y);const L=!y&&g<.08?1+q*(.08-g)/.08:1,N=Math.max(1,Math.floor(i*P)),W=Array.from({length:i},(t,e)=>e).sort((t,e)=>v[e]-v[t]),j=new Set(W.slice(0,N));for(let t=0;t<i;t++){const e=o[t],a=S+t*(d+E);let n,i;if(y)n=Math.min(m,B),i=u-n;else{const t=v[e];n=Math.max(2,Math.min(m,t*Y*L*m)),j.has(e)&&n<O&&(n=Math.min(m,O)),i=u-n}const s=t%T==T-1;if(p.fillStyle=s?w:f,p.fillRect(a,i,d,n),"transparent"!==M&&""!==M){const t=i-x;let n=Number.isFinite(X[e])?X[e]:t;n=t<n?t:Math.min(n+z,t),X[e]=n,p.fillStyle=M,p.fillRect(a,n-b,d,b)}}requestAnimationFrame(c)}l.addEventListener("play",()=>sessionStorage.setItem(u,"1")),l.addEventListener("pause",()=>sessionStorage.setItem(u,"0")),window.addEventListener("pagehide",()=>{try{sessionStorage.setItem(m,String(l.currentTime||0))}catch{}}),l.addEventListener("loadedmetadata",()=>{try{const t=parseFloat(sessionStorage.getItem(m)||"0");Number.isFinite(t)&&l.duration&&t<l.duration&&(l.currentTime=t)}catch{}},{once:!0});const tt=document.querySelector(".preloader"),et=document.querySelector(".overlay-expander"),at=!(!tt||"none"===getComputedStyle(tt).display);if(at){const t=[];tt&&t.push(tt),et&&et!==tt&&t.push(et);let a=!1;const n=o=>{if(a)return;a=!0;const s=G.currentTime;try{$.gain.cancelScheduledValues(s),$.gain.setValueAtTime(0,s)}catch{}G.resume().catch(()=>{}),l.play().then(()=>{sessionStorage.setItem(u,"1")}).catch(()=>{});const r=800,c=1150,d=4e3;let m,h;const p=()=>{t.forEach(t=>t.removeEventListener("click",n,i)),m&&m.disconnect(),h&&clearInterval(h)},v=()=>{if(!tt)return!0;if(!tt.parentNode)return!0;const t=getComputedStyle(tt);return"none"===t.display},g=()=>{n._didFade||(n._didFade=!0,e(1,r),p())};tt&&(m=new MutationObserver(()=>{v()&&g()}),m.observe(tt,{attributes:!0,attributeFilter:["style","class"]})),h=setInterval(()=>{v()&&g()},120),setTimeout(g,c),setTimeout(g,d)},i={once:!0,capture:!0};t.forEach(t=>t.addEventListener("click",n,i))}else"1"===sessionStorage.getItem(u)&&l.play().then(()=>{G.resume().catch(()=>{}),e(1,800)}).catch(()=>{});window.__audioViz&&"function"==typeof window.__audioViz.initToggle&&window.__audioViz.initToggle(),c()}catch(t){console.error("[viz] init error:",t)}}window.__audioVizInit||(window.__audioVizInit=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t,{once:!0}):t())})();