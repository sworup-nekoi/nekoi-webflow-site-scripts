(function(){function t(){try{const s=document.getElementById("audio-viz")||document.querySelector(".audio-visualizer");if(!s)return;const c=document.getElementById("site-music")||document.querySelector('audio[data-role="site-music"]')||document.querySelector("audio#site-audio")||document.querySelector("audio[src]");if(!c)return;try{c.crossOrigin=c.crossOrigin||"anonymous"}catch{}c.preload=c.preload||"auto";const d="viz:was-playing",m="viz:last-time",l=document.createElement("canvas"),u=l.getContext("2d");Object.assign(l.style,{position:"absolute",inset:"0",width:"100%",height:"100%",display:"block",pointerEvents:"none"}),s.appendChild(l);const h=document.body||document.documentElement,v=(t,e)=>{let a=getComputedStyle(h).getPropertyValue(t).trim();return a||(a=getComputedStyle(document.documentElement).getPropertyValue(t).trim()),a||e},p=(t,e)=>{const a=document.createElement("div");a.style.position="absolute",a.style.visibility="hidden",a.style.width=`var(${t})`,(document.body||document.documentElement).appendChild(a);const n=parseFloat(getComputedStyle(a).width);return a.remove(),Number.isFinite(n)?n:e};let M,g,w,y,f,x,z,b,E,S,F,I,L,C,A,q,T,V,k,R,O,B;function t(){M=v("--viz-bar","#fff"),g=v("--viz-bar-alt",M),w=v("--viz-cap","transparent"),z=p("--viz-pad-x",8),b=p("--viz-gap",2),E=Math.max(1,parseInt(v("--viz-max-bars","64"),10)||64),S=Math.max(1,p("--viz-min-bar",8)),y=p("--viz-cap-gap",2),f=p("--viz-cap-h",2),x=Math.max(.02,parseFloat(v("--viz-cap-drop","0.6"))||.6),F=Math.max(.4,parseFloat(v("--viz-band-curve","1.6"))||1.6),I=Math.max(1,parseInt(v("--viz-alt-every","2"),10)||2),L="0"!==v("--viz-agc","1"),C=Math.min(.5,Math.max(.01,parseFloat(v("--viz-agc-smooth","0.1"))||.1)),A=Math.max(1,parseFloat(v("--viz-agc-max","16"))||16),q=Math.max(.1,parseFloat(v("--viz-sensitivity","1.35"))||1.35),T=Math.min(.98,Math.max(0,parseFloat(v("--viz-smoothing","0.60"))||.6)),V=Math.max(0,parseFloat(v("--viz-quiet-boost","1.45"))||1.45),k=Math.min(1,Math.max(0,parseFloat(v("--viz-min-active-frac","0.40"))||.4)),R=p("--viz-min-active-px",3),O=p("--viz-idle-px",2),B=Math.max(0,Math.min(.2,parseFloat(v("--viz-silence-thresh","0.02"))||.02))}t();const P=new MutationObserver(t);P.observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme","data-wf-theme","class"]}),P.observe(document.body,{attributes:!0,attributeFilter:["data-theme","data-wf-theme","class"]});const _=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)");_&&_.addEventListener&&_.addEventListener("change",t);const N=window.AudioContext||window.webkitAudioContext,D=new N;let j;try{j=D.createMediaElementSource(c)}catch{return}const G=D.createAnalyser();G.fftSize=512,G.smoothingTimeConstant=T;const H=D.createGain();H.gain.value=0,j.connect(G),G.connect(H),H.connect(D.destination);let U=Math.max(1,window.devicePixelRatio||1);const W={count:0,ranges:[]};function e(){U=Math.max(1,window.devicePixelRatio||1);const e=s.clientWidth||1,a=s.clientHeight||1;l.width=Math.max(1,Math.round(e*U)),l.height=Math.max(1,Math.round(a*U)),u.setTransform(U,0,0,U,0,0),t(),W.count=0}e(),window.addEventListener("resize",e,{passive:!0}),window.visualViewport&&visualViewport.addEventListener("resize",e,{passive:!0});const $=new Uint8Array(G.frequencyBinCount);function a(t,e,a=2,n=e){const i=Math.max(a+1,Math.min(n,e)),o=Math.max(1,i-a),r=[];for(let e=0;e<t;e++){const n=e/t,s=(e+1)/t,c=Math.pow(n,F),d=Math.pow(s,F);let m=Math.floor(a+c*o),l=Math.floor(a+d*o);m<a&&(m=a),l<=m&&(l=Math.min(i,m+1)),l>i&&(l=i),r.push({i0:m,i1:l})}return r}let J=[],K=1,Q=0;function n(){Q++%12==0&&t(),G.smoothingTimeConstant=T;const e=l.width/U,i=l.height/U;u.clearRect(0,0,e,i),G.getByteFrequencyData($);const o=Math.max(1,e-2*z);let r=Math.max(1,Math.floor(o/Math.max(1,S)));r=Math.min(E,r);const s=b*Math.max(0,r-1),d=Math.max(1,(o-s)/r),m=i-2,h=Math.max(1,m-6);W.count!==r&&(W.count=r,W.ranges=a(r,$.length,2,$.length),J=new Array(r).fill(m-y));const v=new Array(r);let p=1e-4;for(let t=0;t<r;t++){const{i0:e,i1:a}=W.ranges[t];let n=0,i=Math.max(1,a-e);for(let t=e;t<a;t++)n+=$[t]||0;let o=n/i/255;o=Math.max(0,Math.min(1,o*q)),v[t]=o,o>p&&(p=o)}const F=c.paused||c.muted||p<B;if(!F&&L){const t=Math.min(A,.9/p);K+=(t-K)*C}else K+=.2*(1-K);const P=!F&&p<.08?1+V*(.08-p)/.08:1,_=Math.max(1,Math.floor(r*k)),N=Array.from({length:r},(t,e)=>e).sort((t,e)=>v[e]-v[t]),D=new Set(N.slice(0,_));for(let t=0;t<r;t++){const e=z+t*(d+b);let a,n;if(F)a=Math.min(h,O),n=m-a;else{const e=v[t];a=Math.max(2,Math.min(h,e*K*P*h)),D.has(t)&&a<R&&(a=Math.min(h,R)),n=m-a}const i=t%I==I-1;if(u.fillStyle=i?g:M,u.fillRect(e,n,d,a),"transparent"!==w&&""!==w){const a=n-y;let i=Number.isFinite(J[t])?J[t]:a;i=a<i?a:Math.min(i+x,a),J[t]=i,u.fillStyle=w,u.fillRect(e,i-f,d,f)}}requestAnimationFrame(n)}function i(){const t=D.currentTime;H.gain.cancelScheduledValues(t),H.gain.setValueAtTime(H.gain.value,t),H.gain.linearRampToValueAtTime(1,t+1.2)}function o(){D.resume().catch(()=>{}),c.play().catch(()=>{}),i()}function r(){"1"!==sessionStorage.getItem(d)&&sessionStorage.setItem(d,"1"),o()}c.addEventListener("play",()=>sessionStorage.setItem(d,"1")),c.addEventListener("pause",()=>sessionStorage.setItem(d,"0")),window.addEventListener("pagehide",()=>{try{sessionStorage.setItem(m,String(c.currentTime||0))}catch{}}),c.addEventListener("loadedmetadata",()=>{try{const t=parseFloat(sessionStorage.getItem(m)||"0");Number.isFinite(t)&&c.duration&&t<c.duration&&(c.currentTime=t)}catch{}},{once:!0});const X=document.querySelector(".preloader");X&&X.addEventListener("click",r,{once:!0}),"1"===sessionStorage.getItem(d)?c.play().then(()=>{D.resume().catch(()=>{}),i()}).catch(()=>{["pointerdown","click","keydown","touchstart"].forEach(t=>window.addEventListener(t,r,{once:!0,passive:!0}))}):["pointerdown","click","keydown","touchstart"].forEach(t=>window.addEventListener(t,r,{once:!0,passive:!0})),n()}catch(t){console.error("[viz] init error:",t)}}window.__audioVizInit||(window.__audioVizInit=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t,{once:!0}):t())})();