(function(){function t(){try{const u=document.getElementById("audio-viz")||document.querySelector(".audio-visualizer");if(!u)return;const m=document.getElementById("site-music")||document.querySelector('audio[data-role="site-music"]')||document.querySelector("audio#site-audio")||document.querySelector("audio[src]");if(!m)return;try{m.crossOrigin=m.crossOrigin||"anonymous"}catch{}m.preload=m.preload||"auto";try{m.setAttribute("playsinline",""),m.setAttribute("webkit-playsinline","")}catch{}function t(){try{const t=!!m.getAttribute("src"),e=m.getAttribute("data-src");!e||t&&""!==m.src&&m.src!==location.href||m.setAttribute("src",e),"none"===m.preload&&(m.preload="auto"),m.load()}catch{}}const h="viz:was-playing",p="viz:last-time",v=document.createElement("canvas"),g=v.getContext("2d");Object.assign(v.style,{position:"absolute",inset:"0",width:"100%",height:"100%",display:"block",pointerEvents:"none"}),u.appendChild(v);const y=document.body||document.documentElement,f=(t,e)=>{let a=getComputedStyle(y).getPropertyValue(t).trim();return a||(a=getComputedStyle(document.documentElement).getPropertyValue(t).trim()),a||e},w=(t,e)=>{const a=document.createElement("div");a.style.position="absolute",a.style.visibility="hidden",a.style.width=`var(${t})`,(document.body||document.documentElement).appendChild(a);const n=parseFloat(getComputedStyle(a).width);return a.remove(),Number.isFinite(n)?n:e};let M,b,x,z,S,E,I,F,A,T,L,_,V,C,P,q,k,O,R,B,D,N,W;function e(){M=f("--viz-bar","#fff"),b=f("--viz-bar-alt",M),x=f("--viz-cap","transparent"),I=w("--viz-pad-x",8),F=w("--viz-gap",2),A=Math.max(1,parseInt(f("--viz-max-bars","64"),10)||64),T=Math.max(1,w("--viz-min-bar",8)),z=w("--viz-cap-gap",2),S=w("--viz-cap-h",2),E=Math.max(.02,parseFloat(f("--viz-cap-drop","0.6"))||.6),L=Math.max(.4,parseFloat(f("--viz-band-curve","1.6"))||1.6),_=Math.max(1,parseInt(f("--viz-alt-every","2"),10)||2),V="0"!==f("--viz-agc","1"),C=Math.min(.5,Math.max(.01,parseFloat(f("--viz-agc-smooth","0.1"))||.1)),P=Math.max(1,parseFloat(f("--viz-agc-max","16"))||16),q=Math.max(.1,parseFloat(f("--viz-sensitivity","1.35"))||1.35),k=Math.min(.98,Math.max(0,parseFloat(f("--viz-smoothing","0.60"))||.6)),O=Math.max(0,parseFloat(f("--viz-quiet-boost","1.45"))||1.45),R=Math.min(1,Math.max(0,parseFloat(f("--viz-min-active-frac","0.40"))||.4)),B=w("--viz-min-active-px",3),D=w("--viz-idle-px",2),N=Math.max(0,Math.min(.2,parseFloat(f("--viz-silence-thresh","0.02"))||.02)),W=(f("--viz-align","left")||"left").toLowerCase()}e();const j=new MutationObserver(e);j.observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme","data-wf-theme","class"]}),j.observe(document.body,{attributes:!0,attributeFilter:["data-theme","data-wf-theme","class"]});const G=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)");G&&G.addEventListener&&G.addEventListener("change",e);const H=window.AudioContext||window.webkitAudioContext,U=new H;let $;try{$=U.createMediaElementSource(m)}catch{return}const J=U.createAnalyser();J.fftSize=512,J.smoothingTimeConstant=k;const K=U.createGain();function a(t,e=300){const a=U.currentTime,n=Math.max(.001,(0|e)/1e3),i=K.gain;try{i.cancelScheduledValues(a),i.setValueAtTime(i.value,a),i.linearRampToValueAtTime(Math.max(0,Math.min(1,t)),a+n)}catch{}return new Promise(t=>setTimeout(t,Math.max(0,0|e)))}async function n(e=800){try{t()}catch{}try{await U.resume()}catch{}try{await m.play()}catch{}sessionStorage.setItem(h,"1"),await a(1,e)}async function i(t=400){await a(0,t),m.pause(),sessionStorage.setItem(h,"0");try{sessionStorage.setItem(p,String(m.currentTime||0))}catch{}}function o(t={}){const e=t.selector||"[data-viz-toggle]";document.querySelectorAll(e).forEach(e=>s(e,t))}function s(e,a={}){const o=+e.dataset.fadeIn||a.fadeInMs||800,s=+e.dataset.fadeOut||a.fadeOutMs||400;e.setAttribute("role","button"),e.hasAttribute("tabindex")||(e.tabIndex=0),e.style.touchAction="manipulation";const r=e=>{try{e&&(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation()),t(),U.resume().catch(()=>{});const a=U.currentTime;try{K.gain.cancelScheduledValues(a),K.gain.setValueAtTime(0,a)}catch{}}catch{}};e.addEventListener("pointerdown",r,{passive:!1,once:!0});const c=t=>{t&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation&&t.stopImmediatePropagation())},d=t=>{e.classList.toggle("is-playing",!!t),e.setAttribute("aria-pressed",t?"true":"false")},l=t=>{c(t),m.paused||m.ended?n(o).then(()=>d(!0)):i(s).then(()=>d(!1))};e.addEventListener("pointerup",l,{passive:!1}),e.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||l(t)});const u="1"===sessionStorage.getItem(h)&&!m.paused;d(u)}K.gain.value=0,$.connect(K),K.connect(U.destination),K.connect(J),function(){if(m.__vizPersistBound)return;m.__vizPersistBound=!0;const t=()=>{try{sessionStorage.setItem(p,String(m.currentTime||0))}catch{}};m.addEventListener("pause",t),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&t()}),window.addEventListener("pagehide",t),setInterval(()=>{m.paused||t()},2e3)}(),window.__audioViz={audio:m,context:U,analyser:J,gain:K,fadeTo:a,playWithFade:n,pauseWithFade:i,initToggle:o,ensureAudioReady:t};let Q=Math.max(1,window.devicePixelRatio||1);const X={count:0,ranges:[]};function r(){Q=Math.max(1,window.devicePixelRatio||1);const t=u.clientWidth||1,a=u.clientHeight||1;v.width=Math.max(1,Math.round(t*Q)),v.height=Math.max(1,Math.round(a*Q)),g.setTransform(Q,0,0,Q,0,0),e(),X.count=0}r(),window.addEventListener("resize",r,{passive:!0}),window.visualViewport&&visualViewport.addEventListener("resize",r,{passive:!0});const Y=new Uint8Array(J.frequencyBinCount);function c(t,e,a=2,n=e){const i=Math.max(a+1,Math.min(n,e)),o=Math.max(1,i-a),s=[];for(let e=0;e<t;e++){const n=e/t,r=(e+1)/t,c=Math.pow(n,L),d=Math.pow(r,L);let l=Math.floor(a+c*o),u=Math.floor(a+d*o);l<a&&(l=a),u<=l&&(u=Math.min(i,l+1)),u>i&&(u=i),s.push({i0:l,i1:u})}return s}let Z=[],tt=1,et=0;function d(){et++%12==0&&e(),J.smoothingTimeConstant=k;const t=v.width/Q,a=v.height/Q;g.clearRect(0,0,t,a),J.getByteFrequencyData(Y);const n=Math.max(1,t-2*I);let i=Math.max(1,Math.floor(n/Math.max(1,T)));i=Math.min(A,i);let o=[];for(let t=0;t<i;t++)o[t]=t;"right"===W&&o.reverse();const s=F*Math.max(0,i-1),r=Math.max(1,(n-s)/i),l=a-2,u=Math.max(1,l-6);X.count!==i&&(X.count=i,X.ranges=c(i,Y.length,2,Y.length),Z=new Array(i).fill(l-z));const h=new Array(i);let p=1e-4;for(let t=0;t<i;t++){const{i0:e,i1:a}=X.ranges[t];let n=0,i=Math.max(1,a-e);for(let t=e;t<a;t++)n+=Y[t]||0;let o=n/i/255;o=Math.max(0,Math.min(1,o*q)),h[t]=o,o>p&&(p=o)}const y=m.paused||m.muted||p<N;if(!y&&V){const t=Math.min(P,.9/p);tt+=(t-tt)*C}else tt+=.2*(1-tt);const f=!y&&p<.08?1+O*(.08-p)/.08:1,w=Math.max(1,Math.floor(i*R)),L=Array.from({length:i},(t,e)=>e).sort((t,e)=>h[e]-h[t]),j=new Set(L.slice(0,w));for(let t=0;t<i;t++){const e=o[t],a=I+t*(r+F);let n,i;if(y)n=Math.min(u,D),i=l-n;else{const t=h[e];n=Math.max(2,Math.min(u,t*tt*f*u)),j.has(e)&&n<B&&(n=Math.min(u,B)),i=l-n}const s=t%_==_-1;if(g.fillStyle=s?b:M,g.fillRect(a,i,r,n),"transparent"!==x&&""!==x){const t=i-z;let n=Number.isFinite(Z[e])?Z[e]:t;n=t<n?t:Math.min(n+E,t),Z[e]=n,g.fillStyle=x,g.fillRect(a,n-S,r,S)}}requestAnimationFrame(d)}m.addEventListener("play",()=>sessionStorage.setItem(h,"1")),m.addEventListener("pause",()=>sessionStorage.setItem(h,"0")),window.addEventListener("pagehide",()=>{try{sessionStorage.setItem(p,String(m.currentTime||0))}catch{}}),m.addEventListener("loadedmetadata",()=>{try{const t=parseFloat(sessionStorage.getItem(p)||"0");Number.isFinite(t)&&m.duration&&t<m.duration&&(m.currentTime=t)}catch{}},{once:!0});const at=document.querySelector(".preloader"),nt=document.querySelector(".overlay-expander"),it=!(!at||"none"===getComputedStyle(at).display);if(it){const e=()=>{if(!at)return!0;if(!at.parentNode)return!0;const t=getComputedStyle(at);return"none"===t.display},n=()=>!(!nt||"none"===getComputedStyle(nt).pointerEvents);function l(){const n=[];at&&n.push(at),nt&&nt!==at&&n.push(nt);let i=!1;const o={once:!0,capture:!0},s=r=>{if(i)return;i=!0;try{t()}catch{}const c=U.currentTime;try{K.gain.cancelScheduledValues(c),K.gain.setValueAtTime(0,c)}catch{}U.resume().catch(()=>{}),m.play().then(()=>{sessionStorage.setItem(h,"1")}).catch(()=>{});const d=800;let l,u;const p=()=>{n.forEach(t=>t.removeEventListener("click",s,o)),l&&l.disconnect(),u&&clearInterval(u)},v=()=>{s._didFade||e()&&(s._didFade=!0,a(1,d),p())};at&&(l=new MutationObserver(v),l.observe(at,{attributes:!0,attributeFilter:["style","class"]})),u=setInterval(v,120)};n.forEach(t=>t.addEventListener("click",s,o))}if(n())l();else{let t,e,a;const i=()=>{n()&&(o(),l())},o=()=>{t&&t.disconnect(),e&&clearInterval(e),a&&clearTimeout(a)};nt&&(t=new MutationObserver(i),t.observe(nt,{attributes:!0,attributeFilter:["style","class"]})),e=setInterval(i,120),a=setTimeout(i,15e3)}}else if("1"===sessionStorage.getItem(h)){try{t()}catch{}m.play().then(()=>{U.resume().catch(()=>{}),a(1,800)}).catch(()=>{})}window.__audioViz&&"function"==typeof window.__audioViz.initToggle&&window.__audioViz.initToggle(),d()}catch(t){console.error("[viz] init error:",t)}}window.__audioVizInit||(window.__audioVizInit=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t,{once:!0}):t())})();