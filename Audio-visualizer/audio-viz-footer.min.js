(function(){function t(){try{const d=document.getElementById("audio-viz")||document.querySelector(".audio-visualizer");if(!d)return;const m=document.getElementById("site-music")||document.querySelector('audio[data-role="site-music"]')||document.querySelector("audio#site-audio")||document.querySelector("audio[src]");if(!m)return;try{m.setAttribute("playsinline","")}catch{}try{m.crossOrigin=m.crossOrigin||"anonymous"}catch{}m.preload=m.preload||"auto";const l="viz:was-playing",u="viz:last-time",h=document.createElement("canvas"),p=h.getContext("2d");Object.assign(h.style,{position:"absolute",inset:"0",width:"100%",height:"100%",display:"block",pointerEvents:"none"}),d.appendChild(h);const v=document.body||document.documentElement,M=(t,e)=>{let a=getComputedStyle(v).getPropertyValue(t).trim();return a||(a=getComputedStyle(document.documentElement).getPropertyValue(t).trim()),a||e},g=(t,e)=>{const a=document.createElement("div");a.style.position="absolute",a.style.visibility="hidden",a.style.width=`var(${t})`,(document.body||document.documentElement).appendChild(a);const n=parseFloat(getComputedStyle(a).width);return a.remove(),Number.isFinite(n)?n:e};let y,w,f,x,z,E,S,b,F,I,L,A,C,q,T,k,V,R,B,O,P,_,D,N;function t(){y=M("--viz-bar","#fff"),w=M("--viz-bar-alt",y),f=M("--viz-cap","transparent"),S=g("--viz-pad-x",8),b=g("--viz-gap",2),F=Math.max(1,parseInt(M("--viz-max-bars","64"),10)||64),I=Math.max(1,g("--viz-min-bar",8)),x=g("--viz-cap-gap",2),z=g("--viz-cap-h",2),E=Math.max(.02,parseFloat(M("--viz-cap-drop","0.6"))||.6),L=Math.max(.4,parseFloat(M("--viz-band-curve","1.6"))||1.6),A=Math.max(1,parseInt(M("--viz-alt-every","2"),10)||2),C="0"!==M("--viz-agc","1"),q=Math.min(.5,Math.max(.01,parseFloat(M("--viz-agc-smooth","0.1"))||.1)),T=Math.max(1,parseFloat(M("--viz-agc-max","16"))||16),k=Math.max(.1,parseFloat(M("--viz-sensitivity","1.35"))||1.35),V=Math.min(.98,Math.max(0,parseFloat(M("--viz-smoothing","0.60"))||.6)),R=Math.max(0,parseFloat(M("--viz-quiet-boost","1.45"))||1.45),B=Math.min(1,Math.max(0,parseFloat(M("--viz-min-active-frac","0.40"))||.4)),O=g("--viz-min-active-px",3),P=g("--viz-idle-px",2),_=Math.max(0,Math.min(.2,parseFloat(M("--viz-silence-thresh","0.02"))||.02)),D=Math.max(.01,parseFloat(M("--viz-fade-in-s","1.2"))||1.2),N=Math.max(.01,parseFloat(M("--viz-fade-out-s","0.5"))||.5)}t();const j=new MutationObserver(t);j.observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme","data-wf-theme","class"]}),j.observe(document.body,{attributes:!0,attributeFilter:["data-theme","data-wf-theme","class"]});const G=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)");G&&G.addEventListener&&G.addEventListener("change",t);const H=window.AudioContext||window.webkitAudioContext,U=new H;let W;try{W=U.createMediaElementSource(m)}catch{return}const $=U.createAnalyser();$.fftSize=512,$.smoothingTimeConstant=V;const J=U.createGain();J.gain.value=0,W.connect($),$.connect(J),J.connect(U.destination);let K=Math.max(1,window.devicePixelRatio||1);const Q={count:0,ranges:[]};function e(){K=Math.max(1,window.devicePixelRatio||1);const e=d.clientWidth||1,a=d.clientHeight||1;h.width=Math.max(1,Math.round(e*K)),h.height=Math.max(1,Math.round(a*K)),p.setTransform(K,0,0,K,0,0),t(),Q.count=0}e(),window.addEventListener("resize",e,{passive:!0}),window.visualViewport&&visualViewport.addEventListener("resize",e,{passive:!0});const X=new Uint8Array($.frequencyBinCount);function a(t,e,a=2,n=e){const i=Math.max(a+1,Math.min(n,e)),o=Math.max(1,i-a),s=[];for(let e=0;e<t;e++){const n=e/t,r=(e+1)/t,c=Math.pow(n,L),d=Math.pow(r,L);let m=Math.floor(a+c*o),l=Math.floor(a+d*o);m<a&&(m=a),l<=m&&(l=Math.min(i,m+1)),l>i&&(l=i),s.push({i0:m,i1:l})}return s}let Y=[],Z=1,tt=0;function n(){tt++%12==0&&t(),$.smoothingTimeConstant=V;const e=h.width/K,i=h.height/K;p.clearRect(0,0,e,i),$.getByteFrequencyData(X);const o=Math.max(1,e-2*S);let s=Math.max(1,Math.floor(o/Math.max(1,I)));s=Math.min(F,s);const r=b*Math.max(0,s-1),c=Math.max(1,(o-r)/s),d=i-2,l=Math.max(1,d-6);Q.count!==s&&(Q.count=s,Q.ranges=a(s,X.length,2,X.length),Y=new Array(s).fill(d-x));const u=new Array(s);let v=1e-4;for(let t=0;t<s;t++){const{i0:e,i1:a}=Q.ranges[t];let n=0,i=Math.max(1,a-e);for(let t=e;t<a;t++)n+=X[t]||0;let o=n/i/255;o=Math.max(0,Math.min(1,o*k)),u[t]=o,o>v&&(v=o)}const M=m.paused||m.muted||v<_;if(!M&&C){const t=Math.min(T,.9/v);Z+=(t-Z)*q}else Z+=.2*(1-Z);const g=!M&&v<.08?1+R*(.08-v)/.08:1,L=Math.max(1,Math.floor(s*B)),D=Array.from({length:s},(t,e)=>e).sort((t,e)=>u[e]-u[t]),N=new Set(D.slice(0,L));for(let t=0;t<s;t++){const e=S+t*(c+b);let a,n;if(M)a=Math.min(l,P),n=d-a;else{const e=u[t];a=Math.max(2,Math.min(l,e*Z*g*l)),N.has(t)&&a<O&&(a=Math.min(l,O)),n=d-a}const i=t%A==A-1;if(p.fillStyle=i?w:y,p.fillRect(e,n,c,a),"transparent"!==f&&""!==f){const a=n-x;let i=Number.isFinite(Y[t])?Y[t]:a;i=a<i?a:Math.min(i+E,a),Y[t]=i,p.fillStyle=f,p.fillRect(e,i-z,c,z)}}requestAnimationFrame(n)}function i(t,e,a){const n=U.currentTime;J.gain.cancelScheduledValues(n);const i=Math.max(0,Math.min(1,J.gain.value));J.gain.setValueAtTime(i,n),J.gain.linearRampToValueAtTime(t,n+Math.max(.01,e)),a&&setTimeout(a,Math.max(10,1e3*e))}function o(){U.resume().catch(()=>{}),m.play().catch(()=>{}),i(1,D)}function s(){"1"!==sessionStorage.getItem(l)&&sessionStorage.setItem(l,"1"),o()}function r(t){t&&(t.preventDefault(),t.stopPropagation()),m.paused?(sessionStorage.setItem(l,"1"),U.resume().catch(()=>{}),m.play().then(()=>i(1,D)).catch(()=>{})):(sessionStorage.setItem(l,"0"),i(0,N,()=>m.pause()))}function c(){const t=[],e=document.querySelector(".visualizer-wrapper");e&&t.push(e),d&&t.push(d);const a=Array.from(new Set(t.filter(Boolean)));a.forEach(t=>{t.style.cursor=t.style.cursor||"pointer",t.addEventListener("click",r,!1),t.addEventListener("touchend",r,{passive:!1})})}m.addEventListener("play",()=>sessionStorage.setItem(l,"1")),m.addEventListener("pause",()=>sessionStorage.setItem(l,"0")),window.addEventListener("pagehide",()=>{try{sessionStorage.setItem(u,String(m.currentTime||0))}catch{}}),m.addEventListener("loadedmetadata",()=>{try{const t=parseFloat(sessionStorage.getItem(u)||"0");Number.isFinite(t)&&m.duration&&t<m.duration&&(m.currentTime=t)}catch{}},{once:!0});const et=document.querySelector(".preloader");et&&et.addEventListener("click",s,{once:!0}),"1"===sessionStorage.getItem(l)?m.play().then(()=>{U.resume().catch(()=>{}),i(1,D)}).catch(()=>{["pointerdown","click","keydown","touchstart"].forEach(t=>window.addEventListener(t,s,{once:!0,passive:!0}))}):["pointerdown","click","keydown","touchstart"].forEach(t=>window.addEventListener(t,s,{once:!0,passive:!0})),c(),n()}catch(t){console.error("[viz] init error:",t)}}window.__audioVizInit||(window.__audioVizInit=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t,{once:!0}):t())})();